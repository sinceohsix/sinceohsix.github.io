<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Viewer</title>
  <style>
    body {
      margin: 0;
      font-family: monospace;
      background: #111;
      color: #eee;
    }
    #topbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 5px 10px;
      background: #222;
      border-bottom: 1px solid #444;
    }
    #topbar button {
      background: none;
      border: 1px solid #555;
      color: #eee;
      padding: 5px 10px;
      margin-left: 5px;
      cursor: pointer;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 35px);
    }
    #file-browser {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .folder, .file {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 2px 0;
    }
    .file img, .folder img {
      width: 20px;
      height: 20px;
      margin-right: 6px;
      object-fit: contain;
    }
    .indent {
      margin-left: 20px;
    }
    #resizer {
      height: 6px;
      background: #333;
      cursor: row-resize;
    }
    #preview {
      flex: 1;
      overflow: auto;
      background: #000;
      padding: 10px;
      display: none;
    }
    #preview img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: auto;
    }
    #preview audio {
      width: 100%;
    }
    #preview pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <button onclick="window.location.href='https://github.com/sinceohsix'">My GitHub</button>
    <button id="togglePreview">Toggle Preview</button>
  </div>
  <div id="container">
    <div id="file-browser"></div>
    <div id="resizer"></div>
    <div id="preview"></div>
  </div>

  <script>
    const browser = document.getElementById("file-browser");
    const preview = document.getElementById("preview");
    const resizer = document.getElementById("resizer");
    const toggleBtn = document.getElementById("togglePreview");

    // Toggle preview open/close
    toggleBtn.addEventListener("click", () => {
      preview.style.display = preview.style.display === "none" ? "block" : "none";
    });

    // Load manifest.json
    async function loadManifest() {
      try {
        const res = await fetch("./manifest.json");
        if (!res.ok) throw new Error("Failed to fetch manifest: " + res.status);
        const manifest = await res.json();
        renderFiles(manifest.files, browser);
      } catch (err) {
        browser.innerHTML = `<p style="color:red">Error loading manifest.json: ${err.message}</p>`;
      }
    }

    function renderFiles(files, container, depth = 0) {
      files.forEach(file => {
        if (file.type === "folder") {
          const folderDiv = document.createElement("div");
          folderDiv.className = "folder indent".repeat(depth);
          folderDiv.innerHTML = `<img src="folder.png"> ${file.name}`;
          container.appendChild(folderDiv);

          const subContainer = document.createElement("div");
          subContainer.style.display = "none";
          container.appendChild(subContainer);

          folderDiv.addEventListener("click", () => {
            subContainer.style.display = subContainer.style.display === "none" ? "block" : "none";
          });

          renderFiles(file.children, subContainer, depth + 1);
        } else {
          const fileDiv = document.createElement("div");
          fileDiv.className = "file indent".repeat(depth);
          fileDiv.innerHTML = `<img src="file.png"> ${file.name}`;
          fileDiv.addEventListener("click", () => previewFile(file.path));
          container.appendChild(fileDiv);
        }
      });
    }

    async function previewFile(path) {
      preview.style.display = "block";
      const ext = path.split(".").pop().toLowerCase();
      const url = `contents/${path}`;

      try {
        if (["txt", "md"].includes(ext)) {
          const res = await fetch(url);
          const text = await res.text();
          preview.innerHTML = `<pre>${text}</pre>`;
        } else if (["png", "jpg", "jpeg", "gif"].includes(ext)) {
          preview.innerHTML = `<img src="${url}" alt="${path}">`;
        } else if (["mp3", "wav", "ogg"].includes(ext)) {
          preview.innerHTML = `<audio controls src="${url}"></audio>`;
        } else {
          preview.innerHTML = `<p>No preview available. <a href="${url}" download>Download</a></p>`;
        }
      } catch (err) {
        preview.innerHTML = `<p style="color:red">Error loading file: ${err.message}</p>`;
      }
    }

    // Resizer
    let isResizing = false;
    resizer.addEventListener("mousedown", e => {
      isResizing = true;
      document.body.style.cursor = "row-resize";
    });
    document.addEventListener("mousemove", e => {
      if (!isResizing) return;
      const totalHeight = container.clientHeight;
      const newHeight = e.clientY - container.offsetTop;
      const percent = newHeight / totalHeight * 100;
      browser.style.flex = "0 0 " + percent + "%";
      preview.style.flex = "0 0 " + (100 - percent) + "%";
    });
    document.addEventListener("mouseup", () => {
      isResizing = false;
      document.body.style.cursor = "default";
    });

    loadManifest();
  </script>
</body>
</html>
