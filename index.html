<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SinceOhSix — File Browser</title>
<style>
  :root{
    --bg:#fafafa; --fg:#111; --panel:#fff; --muted:#666; --accent:#0077cc; --divider:#cfcfcf;
    --preview-height: 40vh;
    --toolbar-h: 48px;
    --divider-h: 8px;
    --icon-size:28px;
    --btn-radius:8px;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0b0b; --fg:#eaeaea; --panel:#111; --muted:#aaa; --accent:#4ea8ff; --divider:#333; }
  }

  html,body{height:100%;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:var(--bg);color:var(--fg);overflow:hidden;}
  a{color:inherit}

  #toolbar{
    height:var(--toolbar-h);
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:8px;
    padding:8px 12px;
    border-bottom:1px solid var(--divider);
    box-sizing:border-box;
    background:transparent;
  }
  .btn{
    border:1px solid var(--divider);
    background:transparent;
    padding:6px 10px;
    border-radius:var(--btn-radius);
    cursor:pointer;
    font-family:inherit;
    font-size:0.95rem;
    color:var(--fg);
  }

  #container{
    height: calc(100dvh - var(--toolbar-h));
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  #file-browser{
    flex:1 1 auto;
    overflow:auto;
    padding:12px;
    box-sizing:border-box;
    border-bottom:1px solid var(--divider);
    background:var(--panel);
  }

  #hdivider{
    height:var(--divider-h);
    background:linear-gradient(180deg, transparent, rgba(0,0,0,0.02), transparent);
    display:flex; align-items:center; justify-content:center;
    cursor:row-resize;
    user-select:none;
    -webkit-user-select:none;
    box-sizing:border-box;
    position:relative;
  }
  #hdivider .grip {
    width:80px; height:4px; border-radius:2px; background:var(--divider);
    opacity:0.7;
  }
  #hdivider::before{
    content: "";
    position: absolute;
    left: 0; right: 0; top: -14px; bottom: -14px;
    background: transparent;
    pointer-events: auto;
  }

  #previewer{
    flex:0 0 var(--preview-height);
    max-height:var(--preview-height);
    overflow:auto;
    padding:12px;
    box-sizing:border-box;
    background:var(--panel);
    transition:max-height .18s ease, transform .18s ease;
    display:flex; flex-direction:column;
  }
  body.preview-closed #previewer{
    --preview-height: 0px !important;
    max-height:0 !important;
    transform: translateY(100%);
    padding-top:0; padding-bottom:0;
  }

  .tree { font-size:1rem; }
  ul { list-style:none; padding-left:0; margin:0; }
  li { margin:6px 0; display:block; }
  .node { display:flex; align-items:center; gap:10px; padding:6px 4px; border-radius:4px; user-select:none; }
  .node:hover { background:rgba(0,0,0,0.02); }
  .chev { width:14px; display:inline-block; transform:rotate(0); transition: transform .16s ease; }
  .expanded > .chev { transform:rotate(90deg); }
  .icon { width:var(--icon-size); height:var(--icon-size); object-fit:contain; flex:0 0 auto; }
  .name { font-size:1rem; }
  .children { overflow:hidden; max-height:0; transition:max-height .24s ease; }
  .expanded > .children { max-height:2000px; }

  .preview-header { display:flex; gap:12px; align-items:center; border-bottom:1px solid var(--divider); padding-bottom:8px; margin-bottom:8px; }
  .preview-body { overflow:auto; flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px; }
  pre { white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,0.03); padding:10px; border-radius:6px; overflow:auto; align-self:flex-start; width:100%; }
  img.preview { max-width:100%; max-height:100%; object-fit:contain; display:block; border-radius:6px; border:1px solid var(--divider); }

  @media (max-width:700px){
    :root{ --icon-size:32px; }
    #hdivider .grip{ width:56px; }
    .name{ font-size:1.02rem; }
  }
</style>
</head>
<body class="preview-open">
  <div id="toolbar">
    <button id="githubBtn" class="btn">My GitHub</button>
    <button id="togglePreview" class="btn">Hide Preview</button>
  </div>

  <div id="container" role="main">
    <div id="file-browser">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:600">~/</div>
        <div class="muted small">Files from <code>contents/</code></div>
      </div>
      <div id="tree" class="tree">Loading manifest…</div>
    </div>

    <div id="hdivider" title="Drag to resize preview">
      <div class="grip" aria-hidden="true"></div>
    </div>

    <div id="previewer" aria-live="polite">
      <div class="preview-header">
        <img id="previewIcon" class="icon" src="icons/file.png" alt="">
        <div style="min-width:0">
          <div id="previewName" style="font-weight:700">No file selected</div>
          <div id="previewPath" style="color:var(--muted);font-size:0.9rem">—</div>
        </div>
        <div style="flex:1"></div>
        <a id="downloadLink" class="btn" href="#" download style="display:none">Download</a>
      </div>
      <div id="previewBody" class="preview-body">
        <div style="color:var(--muted); width:100%;">Select a file above to preview. Supported: images, text, mp3. Use the divider to resize the preview area.</div>
      </div>
    </div>
  </div>

<script>
const CONTENTS_PREFIX="contents/";
const ICONS={
  folder:"icons/folder.png",
  file:"icons/file.png",
  folder_white:"icons/folder_white.png",
  file_white:"icons/file_white.png",
  photo:"icons/photo.png",
  photo_white:"icons/photo_white.png",
  music:"icons/music.png",
  music_white:"icons/music_white.png"
};
const ICON_SIZES={
  file:[28,28],
  folder:[28,28],
  photo:[48,35],
  music:[29,38]
};

const treeEl=document.getElementById('tree');
const previewBody=document.getElementById('previewBody');
const previewName=document.getElementById('previewName');
const previewPath=document.getElementById('previewPath');
const previewIcon=document.getElementById('previewIcon');
const downloadLink=document.getElementById('downloadLink');
const toggleBtn=document.getElementById('togglePreview');
const hdivider=document.getElementById('hdivider');
const container=document.getElementById('container');
const githubBtn=document.getElementById('githubBtn');

const isDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
function pickIcon(type){ return isDark?ICONS[type+"_white"]:ICONS[type]; }
function pickSize(type){ return ICON_SIZES[type]||ICON_SIZES.file; }
function getFileType(path){
  const ext=path.split('.').pop().toLowerCase();
  if(['png','jpg','jpeg','gif','webp','svg'].includes(ext)) return 'photo';
  if(['mp3','wav','ogg','m4a'].includes(ext)) return 'music';
  return 'file';
}
function encodeSegments(path){ return path.split('/').map(seg=>encodeURIComponent(seg)).join('/'); }

/* Load manifest.json */
async function loadManifest(){
  treeEl.textContent='Loading manifest…';
  try{
    const res=await fetch('manifest.json',{cache:"no-store"});
    if(!res.ok) throw new Error('manifest fetch '+res.status);
    const raw=await res.json();
    let items=[];
    if(Array.isArray(raw)) items=raw;
    else if(Array.isArray(raw.items)) items=raw.items;
    else throw new Error('manifest.json format invalid');
    items=items.map(it=>{
      if(typeof it==='string') return {path:it.replace(/^\/+/,'')};
      if(!it||!it.path) return null;
      return {path:it.path.replace(/^\/+/,''), name:it.name||it.path.split('/').pop()};
    }).filter(Boolean);
    const tree=buildTree(items);
    treeEl.innerHTML='';
    treeEl.appendChild(renderTree(tree));
    const urlPath=new URLSearchParams(location.search).get('path');
    if(urlPath){ openPreview(urlPath); expandToPath(urlPath); }
  }catch(err){ treeEl.textContent='Error loading manifest: '+err; }
}

function buildTree(items){
  const root={};
  for(const it of items){
    const parts=it.path.split('/').filter(Boolean);
    let node=root;
    for(let i=0;i<parts.length;i++){
      const name=parts[i];
      const isFile=(i===parts.length-1)&&name.includes('.');
      if(!node[name]) node[name]={type:isFile?'file':'folder',children:{},data:null};
      if(isFile) node[name].data=it;
      node=node[name].children;
    }
  }
  return root;
}

function renderTree(tree,depth=0){
  const ul=document.createElement('ul');
  Object.entries(tree).forEach(([name,node])=>{
    const li=document.createElement('li');
    const row=document.createElement('div');
    row.className='node '+node.type;
    row.style.paddingLeft=(depth*12)+'px';

    const chev=document.createElement('span'); chev.className='chev'; chev.innerHTML=node.type==='folder'?'&#9654;':'';
    row.appendChild(chev);
    const img=document.createElement('img'); img.className='icon'; img.src=pickIcon(node.type); row.appendChild(img);
    const nameEl=document.createElement('span'); nameEl.className='name'; nameEl.textContent=name; row.appendChild(nameEl);
    li.appendChild(row);

    if(node.type==='folder'){
      const childrenWrap=document.createElement('div'); childrenWrap.className='children';
      li.appendChild(childrenWrap);
      row.addEventListener('click',e=>{
        e.stopPropagation();
        if(row.classList.contains('expanded')){ row.classList.remove('expanded'); animateCollapse(childrenWrap); }
        else{ row.classList.add('expanded'); if(!childrenWrap.hasChildNodes()) childrenWrap.appendChild(renderTree(node.children,depth+1)); animateExpand(childrenWrap); }
      });
    }else{
      row.style.cursor='pointer';
      row.addEventListener('click',e=>{
        e.stopPropagation();
        const logical=node.data.path;
        openPreview(logical);
        history.pushState({},'', '?path='+encodeURIComponent(logical));
        if(document.body.classList.contains('preview-closed')) togglePreview(true);
      });
    }
    ul.appendChild(li);
  });
  return ul;
}

function animateExpand(el){
  el.style.display='block'; const h=el.scrollHeight;
  el.style.maxHeight='0px'; el.offsetHeight;
  el.style.transition='max-height .26s ease'; el.style.maxHeight=h+'px';
  el.addEventListener('transitionend',function te(){ el.style.maxHeight='none'; el.style.transition=''; el.removeEventListener('transitionend',te); });
}
function animateCollapse(el){
  const h=el.scrollHeight; el.style.maxHeight=h+'px'; el.offsetHeight;
  el.style.transition='max-height .22s ease'; el.style.maxHeight='0px';
  el.addEventListener('transitionend',function tc(){ el.style.transition=''; el.removeEventListener('transitionend',tc); });
}

async function openPreview(logicalPath){
  previewName.textContent=logicalPath.split('/').pop();
  previewPath.textContent=logicalPath;
  const type=getFileType(logicalPath);
  previewIcon.src=pickIcon(type); const [w,h]=pickSize(type);
  previewIcon.style.width=w+'px'; previewIcon.style.height=h+'px';
  downloadLink.style.display='none';
  previewBody.innerHTML='<div style="color:var(--muted)">Loading preview…</div>';

  const encoded=encodeSegments(logicalPath); const real=CONTENTS_PREFIX+encoded;
  try{
    const res=await fetch(real); if(!res.ok){ previewBody.innerHTML='<div style="color:var(--muted)">Error '+res.status+'</div>'; return; }
    const ext=logicalPath.split('.').pop().toLowerCase();
    if(['png','jpg','jpeg','gif','webp','svg'].includes(ext)){
      const blob=await res.blob(); const url=URL.createObjectURL(blob);
      const img=document.createElement('img'); img.className='preview'; img.src=url;
      previewBody.innerHTML=''; previewBody.appendChild(img);
      img.onload=()=>URL.revokeObjectURL(url); downloadLink.href=real; downloadLink.style.display='inline-block';
    } else if(['txt','md','json','log','csv','html','css','js'].includes(ext)){
      const text=await res.text(); const pre=document.createElement('pre'); pre.textContent=text;
      previewBody.innerHTML=''; previewBody.appendChild(pre); downloadLink.href=real; downloadLink.style.display='inline-block';
    } else if(['mp3','wav','ogg','m4a'].includes(ext)){
      const blob=await res.blob(); const url=URL.createObjectURL(blob);
      const audio=document.createElement('audio'); audio.controls=true; audio.src=url;
      previewBody.innerHTML=''; previewBody.appendChild(audio); downloadLink.href=real; downloadLink.style.display='inline-block';
    } else {
      previewBody.innerHTML='<div style="color:var(--muted)">No preview available — use Download.</div>'; downloadLink.href=real; downloadLink.style.display='inline-block';
    }
  }catch(err){ previewBody.innerHTML='<div style="color:var(--muted)">Preview failed: '+err+'</div>'; }
}

function expandToPath(path){
  const parts=path.split('/').filter(Boolean); let current=treeEl;
  for(let i=0;i<parts.length-1;i++){
    const part=parts[i]; const rows=current.querySelectorAll(':scope > ul > li > .node');
    let found=null; for(const r of rows){ const nameSpan=r.querySelector('.name'); if(nameSpan&&nameSpan.textContent===part){ found=r; break; } }
    if(!found) return; if(!found.classList.contains('expanded')) found.click();
    const childWrap=found.parentElement.querySelector('.children'); if(!childWrap) return; current=childWrap;
  }
}

function togglePreview(explicitOpen){
  const closed=document.body.classList.contains('preview-closed');
  const shouldOpen=(typeof explicitOpen==='boolean')?explicitOpen:closed;
  if(shouldOpen){
    document.body.classList.remove('preview-closed'); toggleBtn.textContent='Hide Preview';
    const saved=localStorage.getItem('previewHeight'); if(saved) document.documentElement.style.setProperty('--preview-height',saved);
  } else {
    document.body.classList.add('preview-closed'); toggleBtn.textContent='Show Preview';
    const cur=getComputedStyle(document.documentElement).getPropertyValue('--preview-height')||''; if(cur) localStorage.setItem('previewHeight',cur.trim());
  }
}

/* Divider drag */
let dragging=false;
function startDrag(e){ dragging=true; e.preventDefault(); }
function stopDrag(e){ dragging=false; }
function doDrag(e){
  if(!dragging) return;
  const clientY=(e.touches?e.touches[0]:e).clientY; const rect=container.getBoundingClientRect();
  const dividerH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--divider-h'))||8;
  let topH=Math.min(Math.max(clientY-rect.top,80),rect.height-80);
  const previewH=rect.height-topH-dividerH; const val=previewH+'px';
  document.documentElement.style.setProperty('--preview-height',val);
  if(document.body.classList.contains('preview-closed')) togglePreview(true);
  e.preventDefault();
}

hdivider.addEventListener('mousedown',startDrag);
hdivider.addEventListener('touchstart',startDrag,{passive:false});
window.addEventListener('mousemove',doDrag);
window.addEventListener('touchmove',doDrag,{passive:false});
window.addEventListener('mouseup',stopDrag);
window.addEventListener('touchend',stopDrag);

toggleBtn.addEventListener('click',e=>{ e.preventDefault(); togglePreview(); });
githubBtn.addEventListener('click',()=>{ window.open('https://github.com/sinceohsix','_blank'); });

window.addEventListener('popstate',()=>{
  const urlPath=new URLSearchParams(location.search).get('path');
  if(urlPath){ openPreview(urlPath); expandToPath(urlPath); if(document.body.classList.contains('preview-closed')) togglePreview(true); }
  else { previewName.textContent='No file selected'; previewPath.textContent='—'; previewBody.innerHTML='<div style="color:var(--muted)">Select a file above to preview.</div>'; downloadLink.style.display='none'; }
});

(function init(){
  const stored=localStorage.getItem('previewOpen');
  if(stored==='false'){ document.body.classList.add('preview-closed'); toggleBtn.textContent='Show Preview'; }
  loadManifest();
})();
</script>
</body>
</html>
